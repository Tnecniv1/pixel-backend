<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Réinitialiser le mot de passe – Pixel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 480px; margin: 40px auto; padding: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    .muted { color: #666; font-size: 14px; }
    #debug { white-space: pre-wrap; font-size: 12px; background:#f7f7f7; padding:8px; border-radius:8px; display:none; }
    input, button { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
    button { margin-top: 12px; cursor: pointer; }
    .ok { color: #0a7; }
    .err { color: #c33; }
  </style>
</head>
<body>
  <h2>Définir un nouveau mot de passe</h2>
  <div class="card">
    <p id="status" class="muted">Initialisation…</p>
    <form id="form" style="display:none">
      <input id="pwd" type="password" placeholder="Nouveau mot de passe" required />
      <button type="submit">Mettre à jour</button>
    </form>
    <p class="muted" id="hint" style="display:none">Astuce : si ça bloque, rouvre le lien depuis l’e-mail le plus récent, idéalement en navigation privée.</p>
  </div>

  <details style="margin-top:12px">
    <summary>Voir les détails techniques (debug)</summary>
    <div id="debug"></div>
  </details>

  <!-- CDN principal -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Fallback si le CDN principal est bloqué par un bloqueur -->
  <script>
    if (!window.supabase) {
      var s=document.createElement('script');
      s.src='https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js';
      document.head.appendChild(s);
    }
  </script>

  <script>
    // ⬇️ RENSEIGNE TES VALEURS
    const SUPABASE_URL  = "https://vbeatapbkphtjuitfspb.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiZWF0YXBia3BodGp1aXRmc3BiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNTcwMDgsImV4cCI6MjA2OTczMzAwOH0.lmUtz7OIpDOJc-FZYiI1QlwmwwP-CXveb7Y00_MR3kY";

    const debug = (...args) => {
      const el = document.getElementById('debug');
      el.style.display = 'block';
      el.textContent += args.map(a => (typeof a === 'string' ? a : JSON.stringify(a, null, 2))).join(' ') + "\n";
      console.log(...args);
    };
    window.onerror = (m,s,l,c,e)=>{ debug("JS Error:", m, "@", s+":"+l, e&&e.stack); };

    // Attendre que supabase (fallback inclus) soit chargé
    function waitSupabaseLoaded() {
      return new Promise((resolve, reject) => {
        let tries = 0;
        const t = setInterval(() => {
          tries++;
          if (window.supabase && window.supabase.createClient) {
            clearInterval(t); resolve();
          }
          if (tries > 100) { clearInterval(t); reject(new Error("Supabase lib not loaded")); }
        }, 30);
      });
    }

    async function init() {
      const statusEl = document.getElementById('status');
      const formEl   = document.getElementById('form');
      const hintEl   = document.getElementById('hint');

      try {
        await waitSupabaseLoaded();
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        debug("Supabase loaded");

        // 1) Nouveau flux: ?code=... (PKCE)
        const qs   = new URLSearchParams(window.location.search);
        const code = qs.get("code");
        const type = qs.get("type"); // devrait être 'recovery'
        if (code) {
          debug("Found code in query:", {type});
          const { error } = await client.auth.exchangeCodeForSession(code);
          if (error) { debug("exchangeCodeForSession error:", error); throw error; }
          debug("exchangeCodeForSession OK");
        }

        // 2) Ancien flux: #access_token=...&refresh_token=...
        const hash = new URLSearchParams(window.location.hash.slice(1));
        const access_token  = hash.get("access_token");
        const refresh_token = hash.get("refresh_token");
        if (access_token && refresh_token) {
          debug("Found tokens in hash");
          const { error } = await client.auth.setSession({ access_token, refresh_token });
          if (error) { debug("setSession error:", error); throw error; }
          debug("setSession OK");
        }

        // 3) Vérifier la session
        const { data: { session } } = await client.auth.getSession();
        debug("getSession:", !!session, session && { user: session.user?.id, type });
        if (!session) {
          statusEl.className = "err";
          statusEl.textContent = "Auth session missing! Renvoie un nouvel e-mail et ouvre-le immédiatement (onglet privé).";
          hintEl.style.display = 'block';
          return;
        }

        statusEl.className = "ok";
        statusEl.textContent = "Session vérifiée. Saisis ton nouveau mot de passe.";
        formEl.style.display = "block";

        // 4) Soumission : mise à jour du mot de passe
        formEl.addEventListener("submit", async (e) => {
          e.preventDefault();
          const newPwd = document.getElementById("pwd").value.trim();
          if (!newPwd) return;
          statusEl.className = "";
          statusEl.textContent = "Mise à jour…";
          const { error } = await client.auth.updateUser({ password: newPwd });
          if (error) {
            debug("updateUser error:", error);
            statusEl.className = "err";
            statusEl.textContent = "❌ " + (error.message || "Erreur inconnue");
            return;
          }
          statusEl.className = "ok";
          statusEl.textContent = "✅ Mot de passe modifié. Tu peux retourner dans l’app et te connecter.";
          formEl.style.display = "none";
        });

      } catch (e) {
        debug("Init failed:", e && (e.message || e));
        const statusEl = document.getElementById('status');
        statusEl.className = "err";
        statusEl.textContent = "Erreur d'initialisation. Vérifie ta connexion et rouvre le lien depuis l’e-mail le plus récent.";
      }
    }

    // Lance après que le DOM soit prêt
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  </script>
</body>
</html>
