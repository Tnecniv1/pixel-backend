<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ⚠️ mets tes valeurs
  const SUPABASE_URL  = "https://vbeatapbkphtjuitfspb.supabase.co";
  const SUPABASE_ANON = "TON_ANON_KEY";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  const statusEl = document.getElementById("status");
  const formEl   = document.getElementById("form");

  async function init() {
    try {
      // 1) Nouveau flux (query param ?code=...) → on échange pour une session
      const qs = new URLSearchParams(window.location.search);
      const code = qs.get("code");
      if (code) {
        const { error } = await client.auth.exchangeCodeForSession(code);
        if (error) throw error;
      }

      // 2) Ancien flux (hash #access_token=...&refresh_token=...)
      const hash = new URLSearchParams(window.location.hash.slice(1));
      const access_token  = hash.get("access_token");
      const refresh_token = hash.get("refresh_token");
      if (access_token && refresh_token) {
        const { error } = await client.auth.setSession({ access_token, refresh_token });
        if (error) throw error;
      }

      // 3) Vérifie qu'on a bien une session active
      const { data: { session } } = await client.auth.getSession();
      if (!session) {
        statusEl.textContent = "Auth session missing! Ouvre le lien depuis l’e-mail le plus récent.";
        return;
      }

      statusEl.textContent = "Session vérifiée. Saisis ton nouveau mot de passe.";
      formEl.style.display = "block";
    } catch (e) {
      console.error(e);
      statusEl.textContent = "Lien invalide/expiré. Renvoie un nouvel e-mail.";
    }
  }

  document.getElementById("form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const newPwd = document.getElementById("pwd").value.trim();
    statusEl.textContent = "Mise à jour…";
    const { error } = await client.auth.updateUser({ password: newPwd });
    if (error) {
      statusEl.textContent = "❌ " + (error.message || "Erreur inconnue");
      return;
    }
    statusEl.textContent = "✅ Mot de passe modifié. Tu peux retourner dans l’app et te connecter.";
    formEl.style.display = "none";
  });

  init();
</script>
