<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Reset Password – Pixel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body style="font-family:system-ui;max-width:420px;margin:40px auto;padding:16px">
  <h2>Définir un nouveau mot de passe</h2>
  <p id="status">Initialisation…</p>

  <form id="form" style="display:none">
    <input id="pwd" type="password" placeholder="Nouveau mot de passe" required
           style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px" />
    <button type="submit" style="margin-top:12px;padding:10px 14px;border-radius:8px">
      Mettre à jour
    </button>
  </form>

  <!-- supabase-js v2 depuis CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ⚠️ Remplace par ton URL/anon key (trouvés dans Supabase → Settings → API)
    const SUPABASE_URL = "https://vbeatapbkphtjuitfspb.supabase.co";
    const SUPABASE_ANON = "PASTE_YOUR_ANON_KEY";

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const statusEl = document.getElementById('status');
    const formEl = document.getElementById('form');

    // 1) Quand l’utilisateur arrive depuis l’e-mail, Supabase place une session "recovery".
    //    On écoute l’événement pour afficher le formulaire.
    client.auth.onAuthStateChange((event, session) => {
      if (event === 'PASSWORD_RECOVERY' || session) {
        statusEl.textContent = "Session vérifiée. Saisis ton nouveau mot de passe.";
        formEl.style.display = 'block';
      }
    });

    // 2) Parfois, la session est déjà dans l’URL -> on force l’échange si un "code" est présent.
    (async () => {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      if (code) {
        try {
          await client.auth.exchangeCodeForSession(code);
        } catch (e) {
          statusEl.textContent = "Lien invalide ou expiré.";
        }
      } else {
        // pour l’ancien flux (tokens dans le hash)
        const hash = new URLSearchParams(window.location.hash.slice(1));
        if (hash.get('access_token')) {
          // supabase-js v2 prend en charge automatiquement via onAuthStateChange
          statusEl.textContent = "Session détectée. Saisis ton nouveau mot de passe.";
          formEl.style.display = 'block';
        }
      }
    })();

    // 3) Soumission : on met à jour le mot de passe
    document.getElementById('form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const newPwd = document.getElementById('pwd').value.trim();
      statusEl.textContent = "Mise à jour…";
      try {
        const { error } = await client.auth.updateUser({ password: newPwd });
        if (error) throw error;
        statusEl.textContent = "✅ Mot de passe modifié. Tu peux retourner dans l’app et te connecter.";
        formEl.style.display = 'none';
      } catch (err) {
        statusEl.textContent = "❌ " + (err?.message || "Erreur inconnue");
      }
    });
  </script>
</body>
</html>
